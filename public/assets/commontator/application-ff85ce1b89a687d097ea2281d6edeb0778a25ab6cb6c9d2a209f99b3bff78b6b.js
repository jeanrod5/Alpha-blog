!function(){var n="object"==typeof self&&self.self===self&&self||"object"==typeof global&&global.global===global&&global,t=n._,r=Array.prototype,a=Object.prototype,i=r.push,c=r.slice,s=a.toString,e=a.hasOwnProperty,o=Array.isArray,u=Object.keys,l=Object.create,f=function(){},p=function(n){return n instanceof p?n:this instanceof p?void(this._wrapped=n):new p(n)};"undefined"!=typeof exports?("undefined"!=typeof module&&module.exports&&(exports=module.exports=p),exports._=p):n._=p,p.VERSION="1.8.3";var d=function(i,o,n){if(void 0===o)return i;switch(null==n?3:n){case 1:return function(n){return i.call(o,n)};case 2:return function(n,t){return i.call(o,n,t)};case 3:return function(n,t,e){return i.call(o,n,t,e)};case 4:return function(n,t,e,r){return i.call(o,n,t,e,r)}}return function(){return i.apply(o,arguments)}},h=function(n,t,e){return null==n?p.identity:p.isFunction(n)?d(n,t,e):p.isObject(n)?p.matcher(n):p.property(n)};p.iteratee=function(n,t){return h(n,t,Infinity)};var v=function(a,u){return u=null==u?a.length-1:+u,function(n,t){var e,r=Math.max(arguments.length-u,0),i=Array(r);for(e=0;e<r;e++)i[e]=arguments[e+u];switch(u){case 0:return a.call(this,i);case 1:return a.call(this,n,i);case 2:return a.call(this,n,t,i)}var o=Array(u+1);for(e=0;e<u;e++)o[e]=arguments[e];return o[u]=i,a.apply(this,o)}},m=function(n){if(!p.isObject(n))return{};if(l)return l(n);f.prototype=n;var t=new f;return f.prototype=null,t},g=function(t){return function(n){return null==n?void 0:n[t]}},y=Math.pow(2,53)-1,x=g("length"),b=function(n){var t=x(n);return"number"==typeof t&&0<=t&&t<=y};p.each=p.forEach=function(n,t,e){var r,i;if(t=d(t,e),b(n))for(r=0,i=n.length;r<i;r++)t(n[r],r,n);else{var o=p.keys(n);for(r=0,i=o.length;r<i;r++)t(n[o[r]],o[r],n)}return n},p.map=p.collect=function(n,t,e){t=h(t,e);for(var r=!b(n)&&p.keys(n),i=(r||n).length,o=Array(i),a=0;a<i;a++){var u=r?r[a]:a;o[a]=t(n[u],u,n)}return o};var w=function(c){var o=function(n,t,e,r){var i=!b(n)&&p.keys(n),o=(i||n).length,a=0<c?0:o-1;for(r||(e=n[i?i[a]:a],a+=c);0<=a&&a<o;a+=c){var u=i?i[a]:a;e=t(e,n[u],u,n)}return e};return function(n,t,e,r){var i=3<=arguments.length;return o(n,d(t,r,4),e,i)}};p.reduce=p.foldl=p.inject=w(1),p.reduceRight=p.foldr=w(-1),p.find=p.detect=function(n,t,e){var r;if(void 0!==(r=b(n)?p.findIndex(n,t,e):p.findKey(n,t,e))&&-1!==r)return n[r]},p.filter=p.select=function(n,r,t){var i=[];return r=h(r,t),p.each(n,function(n,t,e){r(n,t,e)&&i.push(n)}),i},p.reject=function(n,t,e){return p.filter(n,p.negate(h(t)),e)},p.every=p.all=function(n,t,e){t=h(t,e);for(var r=!b(n)&&p.keys(n),i=(r||n).length,o=0;o<i;o++){var a=r?r[o]:o;if(!t(n[a],a,n))return!1}return!0},p.some=p.any=function(n,t,e){t=h(t,e);for(var r=!b(n)&&p.keys(n),i=(r||n).length,o=0;o<i;o++){var a=r?r[o]:o;if(t(n[a],a,n))return!0}return!1},p.contains=p.includes=p.include=function(n,t,e,r){return b(n)||(n=p.values(n)),("number"!=typeof e||r)&&(e=0),0<=p.indexOf(n,t,e)},p.invoke=v(function(n,e,r){var i=p.isFunction(e);return p.map(n,function(n){var t=i?e:n[e];return null==t?t:t.apply(n,r)})}),p.pluck=function(n,t){return p.map(n,p.property(t))},p.where=function(n,t){return p.filter(n,p.matcher(t))},p.findWhere=function(n,t){return p.find(n,p.matcher(t))},p.max=function(n,r,t){var e,i,o=-Infinity,a=-Infinity;if(null==r&&null!=n)for(var u=0,c=(n=b(n)?n:p.values(n)).length;u<c;u++)e=n[u],o<e&&(o=e);else r=h(r,t),p.each(n,function(n,t,e){i=r(n,t,e),(a<i||i===-Infinity&&o===-Infinity)&&(o=n,a=i)});return o},p.min=function(n,r,t){var e,i,o=Infinity,a=Infinity;if(null==r&&null!=n)for(var u=0,c=(n=b(n)?n:p.values(n)).length;u<c;u++)(e=n[u])<o&&(o=e);else r=h(r,t),p.each(n,function(n,t,e){((i=r(n,t,e))<a||i===Infinity&&o===Infinity)&&(o=n,a=i)});return o},p.shuffle=function(n){return p.sample(n,Infinity)},p.sample=function(n,t,e){if(null==t||e)return b(n)||(n=p.values(n)),n[p.random(n.length-1)];var r=b(n)?p.clone(n):p.values(n),i=x(r);t=Math.max(Math.min(t,i),0);for(var o=i-1,a=0;a<t;a++){var u=p.random(a,o),c=r[a];r[a]=r[u],r[u]=c}return r.slice(0,t)},p.sortBy=function(n,r,t){return r=h(r,t),p.pluck(p.map(n,function(n,t,e){return{value:n,index:t,criteria:r(n,t,e)}}).sort(function(n,t){var e=n.criteria,r=t.criteria;if(e!==r){if(r<e||void 0===e)return 1;if(e<r||void 0===r)return-1}return n.index-t.index}),"value")};var I=function(a,t){return function(r,i,n){var o=t?[[],[]]:{};return i=h(i,n),p.each(r,function(n,t){var e=i(n,t,r);a(o,n,e)}),o}};p.groupBy=I(function(n,t,e){p.has(n,e)?n[e].push(t):n[e]=[t]}),p.indexBy=I(function(n,t,e){n[e]=t}),p.countBy=I(function(n,t,e){p.has(n,e)?n[e]++:n[e]=1}),p.toArray=function(n){return n?p.isArray(n)?c.call(n):b(n)?p.map(n,p.identity):p.values(n):[]},p.size=function(n){return null==n?0:b(n)?n.length:p.keys(n).length},p.partition=I(function(n,t,e){n[e?0:1].push(t)},!0),p.first=p.head=p.take=function(n,t,e){if(null!=n)return null==t||e?n[0]:p.initial(n,n.length-t)},p.initial=function(n,t,e){return c.call(n,0,Math.max(0,n.length-(null==t||e?1:t)))},p.last=function(n,t,e){if(null!=n)return null==t||e?n[n.length-1]:p.rest(n,Math.max(0,n.length-t))},p.rest=p.tail=p.drop=function(n,t,e){return c.call(n,null==t||e?1:t)},p.compact=function(n){return p.filter(n,p.identity)};var A=function(n,t,e,r){for(var i=(r=r||[]).length,o=0,a=x(n);o<a;o++){var u=n[o];if(b(u)&&(p.isArray(u)||p.isArguments(u)))if(t)for(var c=0,l=u.length;c<l;)r[i++]=u[c++];else A(u,t,e,r),i=r.length;else e||(r[i++]=u)}return r};p.flatten=function(n,t){return A(n,t,!1)},p.without=v(function(n,t){return p.difference(n,t)}),p.uniq=p.unique=function(n,t,e,r){p.isBoolean(t)||(r=e,e=t,t=!1),null!=e&&(e=h(e,r));for(var i=[],o=[],a=0,u=x(n);a<u;a++){var c=n[a],l=e?e(c,a,n):c;t?(a&&o===l||i.push(c),o=l):e?p.contains(o,l)||(o.push(l),i.push(c)):p.contains(i,c)||i.push(c)}return i},p.union=v(function(n){return p.uniq(A(n,!0,!0))}),p.intersection=function(n){for(var t=[],e=arguments.length,r=0,i=x(n);r<i;r++){var o=n[r];if(!p.contains(t,o)){var a;for(a=1;a<e&&p.contains(arguments[a],o);a++);a===e&&t.push(o)}}return t},p.difference=v(function(n,t){return t=A(t,!0,!0),p.filter(n,function(n){return!p.contains(t,n)})}),p.unzip=function(n){for(var t=n&&p.max(n,x).length||0,e=Array(t),r=0;r<t;r++)e[r]=p.pluck(n,r);return e},p.zip=v(p.unzip),p.object=function(n,t){for(var e={},r=0,i=x(n);r<i;r++)t?e[n[r]]=t[r]:e[n[r][0]]=n[r][1];return e};var E=function(o){return function(n,t,e){t=h(t,e);for(var r=x(n),i=0<o?0:r-1;0<=i&&i<r;i+=o)if(t(n[i],i,n))return i;return-1}};p.findIndex=E(1),p.findLastIndex=E(-1),p.sortedIndex=function(n,t,e,r){for(var i=(e=h(e,r,1))(t),o=0,a=x(n);o<a;){var u=Math.floor((o+a)/2);e(n[u])<i?o=u+1:a=u}return o};var j=function(o,a,u){return function(n,t,e){var r=0,i=x(n);if("number"==typeof e)0<o?r=0<=e?e:Math.max(e+i,r):i=0<=e?Math.min(e+1,i):e+i+1;else if(u&&e&&i)return n[e=u(n,t)]===t?e:-1;if(t!=t)return 0<=(e=a(c.call(n,r,i),p.isNaN))?e+r:-1;for(e=0<o?r:i-1;0<=e&&e<i;e+=o)if(n[e]===t)return e;return-1}};p.indexOf=j(1,p.findIndex,p.sortedIndex),p.lastIndexOf=j(-1,p.findLastIndex),p.range=function(n,t,e){null==t&&(t=n||0,n=0),e=e||1;for(var r=Math.max(Math.ceil((t-n)/e),0),i=Array(r),o=0;o<r;o++,n+=e)i[o]=n;return i};var _=function(n,t,e,r,i){if(!(r instanceof t))return n.apply(e,i);var o=m(n.prototype),a=n.apply(o,i);return p.isObject(a)?a:o};p.bind=v(function(t,e,r){if(!p.isFunction(t))throw new TypeError("Bind must be called on a function");var i=v(function(n){return _(t,i,e,this,r.concat(n))});return i}),p.partial=v(function(i,o){var a=p.partial.placeholder,u=function(){for(var n=0,t=o.length,e=Array(t),r=0;r<t;r++)e[r]=o[r]===a?arguments[n++]:o[r];for(;n<arguments.length;)e.push(arguments[n++]);return _(i,u,this,this,e)};return u}),(p.partial.placeholder=p).bindAll=v(function(n,t){var e=(t=A(t,!1,!1)).length;if(e<1)throw new Error("bindAll must be passed function names");for(;e--;){var r=t[e];n[r]=p.bind(n[r],n)}}),p.memoize=function(r,i){var o=function(n){var t=o.cache,e=""+(i?i.apply(this,arguments):n);return p.has(t,e)||(t[e]=r.apply(this,arguments)),t[e]};return o.cache={},o},p.delay=v(function(n,t,e){return setTimeout(function(){return n.apply(null,e)},t)}),p.defer=p.partial(p.delay,p,1),p.throttle=function(e,r,i){var o,a,u,c=null,l=0;i||(i={});var f=function(){l=!1===i.leading?0:p.now(),c=null,u=e.apply(o,a),c||(o=a=null)};return function(){var n=p.now();l||!1!==i.leading||(l=n);var t=r-(n-l);return o=this,a=arguments,t<=0||r<t?(c&&(clearTimeout(c),c=null),l=n,u=e.apply(o,a),c||(o=a=null)):c||!1===i.trailing||(c=setTimeout(f,t)),u}},p.debounce=function(t,e,r){var i,o,a,u,c,l=function(){var n=p.now()-u;n<e&&0<=n?i=setTimeout(l,e-n):(i=null,r||(c=t.apply(a,o),i||(a=o=null)))};return function(){a=this,o=arguments,u=p.now();var n=r&&!i;return i||(i=setTimeout(l,e)),n&&(c=t.apply(a,o),a=o=null),c}},p.wrap=function(n,t){return p.partial(t,n)},p.negate=function(n){return function(){return!n.apply(this,arguments)}},p.compose=function(){var e=arguments,r=e.length-1;return function(){for(var n=r,t=e[r].apply(this,arguments);n--;)t=e[n].call(this,t);return t}},p.after=function(n,t){return function(){if(--n<1)return t.apply(this,arguments)}},p.before=function(n,t){var e;return function(){return 0<--n&&(e=t.apply(this,arguments)),n<=1&&(t=null),e}},p.once=p.partial(p.before,2),p.restArgs=v;var C=!{toString:null}.propertyIsEnumerable("toString"),k=["valueOf","isPrototypeOf","toString","propertyIsEnumerable","hasOwnProperty","toLocaleString"],O=function(n,t){var e=k.length,r=n.constructor,i=p.isFunction(r)&&r.prototype||a,o="constructor";for(p.has(n,o)&&!p.contains(t,o)&&t.push(o);e--;)(o=k[e])in n&&n[o]!==i[o]&&!p.contains(t,o)&&t.push(o)};p.keys=function(n){if(!p.isObject(n))return[];if(u)return u(n);var t=[];for(var e in n)p.has(n,e)&&t.push(e);return C&&O(n,t),t},p.allKeys=function(n){if(!p.isObject(n))return[];var t=[];for(var e in n)t.push(e);return C&&O(n,t),t},p.values=function(n){for(var t=p.keys(n),e=t.length,r=Array(e),i=0;i<e;i++)r[i]=n[t[i]];return r},p.mapObject=function(n,t,e){t=h(t,e);for(var r=p.keys(n),i=r.length,o={},a=0;a<i;a++){var u=r[a];o[u]=t(n[u],u,n)}return o},p.pairs=function(n){for(var t=p.keys(n),e=t.length,r=Array(e),i=0;i<e;i++)r[i]=[t[i],n[t[i]]];return r},p.invert=function(n){for(var t={},e=p.keys(n),r=0,i=e.length;r<i;r++)t[n[e[r]]]=e[r];return t},p.functions=p.methods=function(n){var t=[];for(var e in n)p.isFunction(n[e])&&t.push(e);return t.sort()};var S=function(c,l){return function(n){var t=arguments.length;if(t<2||null==n)return n;for(var e=1;e<t;e++)for(var r=arguments[e],i=c(r),o=i.length,a=0;a<o;a++){var u=i[a];l&&void 0!==n[u]||(n[u]=r[u])}return n}};p.extend=S(p.allKeys),p.extendOwn=p.assign=S(p.keys),p.findKey=function(n,t,e){t=h(t,e);for(var r,i=p.keys(n),o=0,a=i.length;o<a;o++)if(t(n[r=i[o]],r,n))return r};var T,M,R=function(n,t,e){return t in e};p.pick=v(function(n,t){var e={},r=t[0];if(null==n)return e;p.isFunction(r)?(1<t.length&&(r=d(r,t[1])),t=p.allKeys(n)):(r=R,t=A(t,!1,!1),n=Object(n));for(var i=0,o=t.length;i<o;i++){var a=t[i],u=n[a];r(u,a,n)&&(e[a]=u)}return e}),p.omit=v(function(n,e){var t,r=e[0];return p.isFunction(r)?(r=p.negate(r),1<e.length&&(t=e[1])):(e=p.map(A(e,!1,!1),String),r=function(n,t){return!p.contains(e,t)}),p.pick(n,r,t)}),p.defaults=S(p.allKeys,!0),p.create=function(n,t){var e=m(n);return t&&p.extendOwn(e,t),e},p.clone=function(n){return p.isObject(n)?p.isArray(n)?n.slice():p.extend({},n):n},p.tap=function(n,t){return t(n),n},p.isMatch=function(n,t){var e=p.keys(t),r=e.length;if(null==n)return!r;for(var i=Object(n),o=0;o<r;o++){var a=e[o];if(t[a]!==i[a]||!(a in i))return!1}return!0},T=function(n,t,e,r){if(n===t)return 0!==n||1/n==1/t;if(null==n||null==t)return n===t;if(n!=n)return t!=t;var i=typeof n;return("function"===i||"object"===i||"object"==typeof t)&&M(n,t,e,r)},M=function(n,t,e,r){n instanceof p&&(n=n._wrapped),t instanceof p&&(t=t._wrapped);var i=s.call(n);if(i!==s.call(t))return!1;switch(i){case"[object RegExp]":case"[object String]":return""+n==""+t;case"[object Number]":return+n!=+n?+t!=+t:0==+n?1/+n==1/t:+n==+t;case"[object Date]":case"[object Boolean]":return+n==+t}var o="[object Array]"===i;if(!o){if("object"!=typeof n||"object"!=typeof t)return!1;var a=n.constructor,u=t.constructor;if(a!==u&&!(p.isFunction(a)&&a instanceof a&&p.isFunction(u)&&u instanceof u)&&"constructor"in n&&"constructor"in t)return!1}r=r||[];for(var c=(e=e||[]).length;c--;)if(e[c]===n)return r[c]===t;if(e.push(n),r.push(t),o){if((c=n.length)!==t.length)return!1;for(;c--;)if(!T(n[c],t[c],e,r))return!1}else{var l,f=p.keys(n);if(c=f.length,p.keys(t).length!==c)return!1;for(;c--;)if(l=f[c],!p.has(t,l)||!T(n[l],t[l],e,r))return!1}return e.pop(),r.pop(),!0},p.isEqual=function(n,t){return T(n,t)},p.isEmpty=function(n){return null==n||(b(n)&&(p.isArray(n)||p.isString(n)||p.isArguments(n))?0===n.length:0===p.keys(n).length)},p.isElement=function(n){return!(!n||1!==n.nodeType)},p.isArray=o||function(n){return"[object Array]"===s.call(n)},p.isObject=function(n){var t=typeof n;return"function"===t||"object"===t&&!!n},p.each(["Arguments","Function","String","Number","Date","RegExp","Error"],function(t){p["is"+t]=function(n){return s.call(n)==="[object "+t+"]"}}),p.isArguments(arguments)||(p.isArguments=function(n){return p.has(n,"callee")}),"function"!=typeof/./&&"object"!=typeof Int8Array&&(p.isFunction=function(n){return"function"==typeof n||!1}),p.isFinite=function(n){return isFinite(n)&&!isNaN(parseFloat(n))},p.isNaN=function(n){return p.isNumber(n)&&n!==+n},p.isBoolean=function(n){return!0===n||!1===n||"[object Boolean]"===s.call(n)},p.isNull=function(n){return null===n},p.isUndefined=function(n){return void 0===n},p.has=function(n,t){return null!=n&&e.call(n,t)},p.noConflict=function(){return n._=t,this},p.identity=function(n){return n},p.constant=function(n){return function(){return n}},p.noop=function(){},p.property=g,p.propertyOf=function(t){return null==t?function(){}:function(n){return t[n]}},p.matcher=p.matches=function(t){return t=p.extendOwn({},t),function(n){return p.isMatch(n,t)}},p.times=function(n,t,e){var r=Array(Math.max(0,n));t=d(t,e,1);for(var i=0;i<n;i++)r[i]=t(i);return r},p.random=function(n,t){return null==t&&(t=n,n=0),n+Math.floor(Math.random()*(t-n+1))},p.now=Date.now||function(){return(new Date).getTime()};var $={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#x27;","`":"&#x60;"},F=p.invert($),N=function(t){var e=function(n){return t[n]},n="(?:"+p.keys(t).join("|")+")",r=RegExp(n),i=RegExp(n,"g");return function(n){return n=null==n?"":""+n,r.test(n)?n.replace(i,e):n}};p.escape=N($),p.unescape=N(F),p.result=function(n,t,e){var r=null==n?void 0:n[t];return void 0===r&&(r=e),p.isFunction(r)?r.call(n):r};var B=0;p.uniqueId=function(n){var t=++B+"";return n?n+t:t},p.templateSettings={evaluate:/<%([\s\S]+?)%>/g,interpolate:/<%=([\s\S]+?)%>/g,escape:/<%-([\s\S]+?)%>/g};var L=/(.)^/,D={"'":"'","\\":"\\","\r":"r","\n":"n","\u2028":"u2028","\u2029":"u2029"},q=/\\|'|\r|\n|\u2028|\u2029/g,P=function(n){return"\\"+D[n]};p.template=function(o,n,t){!n&&t&&(n=t),n=p.defaults({},n,p.templateSettings);var e,r=RegExp([(n.escape||L).source,(n.interpolate||L).source,(n.evaluate||L).source].join("|")+"|$","g"),a=0,u="__p+='";o.replace(r,function(n,t,e,r,i){return u+=o.slice(a,i).replace(q,P),a=i+n.length,t?u+="'+\n((__t=("+t+"))==null?'':_.escape(__t))+\n'":e?u+="'+\n((__t=("+e+"))==null?'':__t)+\n'":r&&(u+="';\n"+r+"\n__p+='"),n}),u+="';\n",n.variable||(u="with(obj||{}){\n"+u+"}\n"),u="var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};\n"+u+"return __p;\n";try{e=new Function(n.variable||"obj","_",u)}catch(l){throw l.source=u,l}var i=function(n){return e.call(this,n,p)},c=n.variable||"obj";return i.source="function("+c+"){\n"+u+"}",i},p.chain=function(n){var t=p(n);return t._chain=!0,t};var K=function(n,t){return n._chain?p(t).chain():t};p.mixin=function(e){p.each(p.functions(e),function(n){var t=p[n]=e[n];p.prototype[n]=function(){var n=[this._wrapped];return i.apply(n,arguments),K(this,t.apply(p,n))}})},p.mixin(p),p.each(["pop","push","reverse","shift","sort","splice","unshift"],function(t){var e=r[t];p.prototype[t]=function(){var n=this._wrapped;return e.apply(n,arguments),"shift"!==t&&"splice"!==t||0!==n.length||delete n[0],K(this,n)}}),p.each(["concat","join","slice"],function(n){var t=r[n];p.prototype[n]=function(){return K(this,t.apply(this._wrapped,arguments))}}),p.prototype.value=function(){return this._wrapped},p.prototype.valueOf=p.prototype.toJSON=p.prototype.value,p.prototype.toString=function(){return""+this._wrapped},"function"==typeof define&&define.amd&&define("underscore",[],function(){return p})}(),function($,F){var N={BACKSPACE:8,TAB:9,RETURN:13,ESC:27,LEFT:37,UP:38,RIGHT:39,DOWN:40,COMMA:188,SPACE:32,HOME:36,END:35},B={triggerChar:"@",onDataRequest:$.noop,minChars:2,allowRepeat:!1,showAvatars:!0,elastic:!0,defaultValue:"",onCaret:!1,classes:{autoCompleteItemActive:"active"},templates:{wrapper:F.template('<div class="mentions-input-box"></div>'),autocompleteList:F.template('<div class="mentions-autocomplete-list"></div>'),autocompleteListItem:F.template('<li data-ref-id="<%= id %>" data-ref-type="<%= type %>" data-display="<%= display %>"><%= content %></li>'),autocompleteListItemAvatar:F.template('<img src="<%= avatar %>" />'),autocompleteListItemIcon:F.template('<div class="icon <%= icon %>"></div>'),mentionsOverlay:F.template('<div class="mentions"><div></div></div>'),mentionItemSyntax:F.template("@[<%= value %>](<%= type %>:<%= id %>)"),mentionItemHighlight:F.template("<strong><span><%= value %></span></strong>")}},L={htmlEncode:function(n){return F.escape(n)},regexpEncode:function(n){return n.replace(/([.*+?^=!:${}()|\[\]\/\\])/g,"\\$1")},highlightTerm:function(n,t){return t||t.length?n.replace(new RegExp("(?![^&;]+;)(?!<[^<>]*)("+t+")(?![^<>]*>)(?![^&;]+;)","gi"),"<b>$1</b>"):n},setCaratPosition:function(n,t){if(n.createTextRange){var e=n.createTextRange();e.move("character",t),e.select()}else n.selectionStart?(n.focus(),n.setSelectionRange(t,t)):n.focus()},rtrim:function(n){return n.replace(/\s+$/,"")}},i=function(l){function t(){"true"!==(E=$(A)).attr("data-mentions-input")&&(j=E.parent(),C=$(l.templates.wrapper()),E.wrapAll(C),C=j.find("> div.mentions-input-box"),E.attr("data-mentions-input","true"),E.bind("keydown",m),E.bind("keypress",v),E.bind("click",c),E.bind("blur",d),-1<navigator.userAgent.indexOf("MSIE 8")?E.bind("propertychange",h):E.bind("input",h),l.elastic&&E.elastic())}function e(){(_=$(l.templates.autocompleteList())).appendTo(C),_.delegate("li","mousedown",n)}function r(){(k=$(l.templates.mentionsOverlay())).prependTo(C)}function f(){var e=p();F.each(S,function(n){var t=l.templates.mentionItemSyntax(n);e=e.replace(new RegExp(L.regexpEncode(n.value),"g"),t)});var i=L.htmlEncode(e);F.each(S,function(n){var t=F.extend({},n,{value:L.htmlEncode(n.value)}),e=l.templates.mentionItemSyntax(t),r=l.templates.mentionItemHighlight(t);i=i.replace(new RegExp(L.regexpEncode(e),"g"),r)}),i=(i=i.replace(/\n/g,"<br />")).replace(/ {2}/g,"&nbsp; "),E.data("messageText",e),E.trigger("updated"),k.find("div").html(i)}function s(){M=[]}function i(){var t=p();S=F.reject(S,function(n){return!n.value||-1==t.indexOf(n.value)}),S=F.compact(S)}function o(t){var n=p(),e=new RegExp("\\"+l.triggerChar+R,"gi");e.exec(n);var r=e.lastIndex-R.length-1,i=e.lastIndex,o=n.substr(0,r),a=n.substr(i,n.length),u=(o+t.value).length+1;F.find(S,function(n){return n.id==t.id})||S.push(t),s(),R="",g();var c=o+t.value+" "+a;E.val(c),E.trigger("mention"),f(),E.focus(),L.setCaratPosition(E[0],u)}function p(){return $.trim(E.val())}function a(n){var t,e,r,i,o,a,u,c,l,f,s;if((l=n[0])&&$(l).is("textarea")&&null!=l.selectionEnd){for(u={position:"absolute",overflow:"auto",whiteSpace:"pre-wrap",wordWrap:"break-word",boxSizing:"content-box",top:0,left:-9999},f=0,s=(c=["boxSizing","fontFamily","fontSize","fontStyle","fontVariant","fontWeight","height","letterSpacing","lineHeight","paddingBottom","paddingLeft","paddingRight","paddingTop","textDecoration","textIndent","textTransform","width","word-spacing"]).length;f<s;f++)u[o=c[f]]=$(l).css(o);return r=document.createElement("div"),$(r).css(u),$(l).after(r),e=document.createTextNode(l.value.substring(0,l.selectionEnd)),t=document.createTextNode(l.value.substring(l.selectionEnd)),(i=document.createElement("span")).innerHTML="&nbsp;",r.appendChild(e),r.appendChild(i),r.appendChild(t),r.scrollTop=l.scrollTop,a=$(i).position(),$(r).remove(),a}}function u(){var n=$(E).offset().top,t=$("body").offset().top;n<$(window).scrollTop()&&$(window).scrollTop(n-t)}function n(){var n=$(this);return o(T[n.attr("data-uid")]),u(),!1}function c(){s()}function d(){g()}function h(){f(),i();var n=F.lastIndexOf(M,l.triggerChar);-1<n&&(R=M.slice(n+1).join(""),R=L.rtrim(R),F.defer(F.bind(b,this,R)))}function v(n){if(n.keyCode!==N.BACKSPACE){var t=String.fromCharCode(n.which||n.keyCode);M.push(t)}}function m(n){if(n.keyCode===N.LEFT||n.keyCode===N.RIGHT||n.keyCode===N.HOME||n.keyCode===N.END)return F.defer(s),void(-1<navigator.userAgent.indexOf("MSIE 9")&&F.defer(f));if(n.keyCode!==N.BACKSPACE){if(!_.is(":visible"))return!0;switch(n.keyCode){case N.UP:case N.DOWN:var t=null;return(t=n.keyCode===N.DOWN?O&&O.length?O.next():_.find("li").first():$(O).prev()).length&&y(t),!1;case N.RETURN:case N.TAB:if(O&&O.length)return O.trigger("mousedown"),!1}return!0}M=M.slice(0,-1+M.length)}function g(){O=null,_.empty().hide()}function y(n){n.addClass(l.classes.autoCompleteItemActive),n.siblings().removeClass(l.classes.autoCompleteItemActive),O=n}function x(i,n){if(_.show(),!l.allowRepeat){var t=F.pluck(S,"value");n=F.reject(n,function(n){return F.include(t,n.name)})}if(n.length){_.empty();var o=$("<ul>").appendTo(_).hide();F.each(n,function(n,t){var e=F.uniqueId("mention_");T[e]=F.extend({},n,{value:n.name});var r=$(l.templates.autocompleteListItem({id:L.htmlEncode(n.id),display:L.htmlEncode(n.name),type:L.htmlEncode(n.type),content:L.highlightTerm(L.htmlEncode(n.display?n.display:n.name),i)})).attr("data-uid",e);(0===t&&y(r),l.showAvatars)&&(n.avatar?$(l.templates.autocompleteListItemAvatar({avatar:n.avatar})):$(l.templates.autocompleteListItemIcon({icon:n.icon}))).prependTo(r);r=r.appendTo(o)}),_.show(),l.onCaret&&w(_,E),o.show()}else g()}function b(t){t&&t.length&&t.length>=l.minChars?l.onDataRequest.call(this,"search",t,function(n){x(t,n)}):g()}function w(n,t){var e=a(t),r=parseInt(t.css("line-height"),10)||18;n.css("width","15em"),n.css("left",e.left),n.css("top",r+e.top);var i=t.offset().left+t.width(),o=n.offset().left+n.width();i<=o&&n.css("left",Math.abs(n.position().left-(o-i)))}function I(n){S=[];for(var t,e=L.htmlEncode(n),r=new RegExp("("+l.triggerChar+")\\[(.*?)\\]\\((.*?):(.*?)\\)","gi"),i=e;null!=(t=r.exec(e));)i=i.replace(t[0],t[1]+t[2]),S.push({id:t[4],type:t[3],value:t[2],trigger:t[1]});E.val(i),f()}var A,E,j,_,C,k,O,S=[],T={},M=[],R="";return l=$.extend(!0,{},B,l),{init:function(n){A=n,t(),e(),r(),I(l.defaultValue),l.prefillMention&&o(l.prefillMention)},val:function(n){F.isFunction(n)&&n.call(this,S.length?E.data("messageText"):p())},reset:function(){I()},getMentions:function(n){F.isFunction(n)&&n.call(this,S)}}};$.fn.mentionsInput=function(t,e){var r=arguments;return"object"!=typeof t&&t||(e=t),this.each(function(){var n=$.data(this,"mentionsInput")||$.data(this,"mentionsInput",new i(e));return F.isFunction(n[t])?n[t].apply(this,Array.prototype.slice.call(r,1)):"object"!=typeof t&&t?void $.error("Method "+t+" does not exist"):n.init.call(this,this)})}}(jQuery,_),window.Commontator={},Commontator._=window._.noConflict(),Commontator.initMentions=function(){$(".comment_form_field textarea:not(.mentions-added)").each(function(n,t){$textarea=$(t),$form=$textarea.parents("form"),threadId=$textarea.parents(".thread").attr("id").match(/[\d]+/)[0],$textarea.addClass("mentions-added"),currentValue=$textarea.val(),$textarea.mentionsInput({elastic:!1,showAvatars:!1,allowRepeat:!0,minChars:3,onDataRequest:function(n,t,e){$.getJSON("/commontator/threads/"+threadId+"/mentions.json",{q:t},function(n){e.call(this,n.mentions)})}}),$textarea.val(currentValue),$textarea.on("focusout",function(){$textarea.mentionsInput("getMentions",function(n){$form.find('input[name="mentioned_ids[]"]').remove(),$(n).each(function(n,t){$input=$("<input>",{type:"hidden",name:"mentioned_ids[]",value:t.id}),$form.append($input)})})})})};